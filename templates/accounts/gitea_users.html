{% extends "base_sidebar.html" %}
{% load static %}

{% block title %}Gitea Users{% endblock %}

{% block content %}

<div class="og-card p-3 p-md-4">

  <!-- Header / Search -->
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
    <h1 class="h5 m-0">Gitea Users</h1>

    <form method="get" class="d-flex gap-2 align-items-center">
      <div class="form-floating" style="min-width: 260px;">
        <input type="text" class="form-control" id="qInput" name="query" placeholder="Search"
               value="{{ query }}">
        <label for="qInput">Search</label>
      </div>

      <div class="form-floating" style="min-width: 140px;">
        <select class="form-select" id="limitSelect" name="limit">
          {% for opt in limit_options %}
            <option value="{{ opt }}" {% if limit == opt %}selected{% endif %}>{{ opt }}/page</option>
          {% endfor %}
        </select>
        <label for="limitSelect">Page size</label>
      </div>

      <button class="btn btn-primary" type="submit">Apply</button>
    </form>
  </div>

  {% if error %}
    <div class="alert alert-warning mb-3">
      <strong>Warning:</strong> {{ error }}
    </div>
  {% endif %}

  <!-- Summary -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
    <div class="text-muted small">
      {% if total %}
        Showing page <strong>{{ page }}</strong> — total <strong>{{ total }}</strong> result{{ total|pluralize }}
      {% else %}
        Showing page <strong>{{ page }}</strong>
      {% endif %}
      {% if query %} • Filter: “<em>{{ query }}</em>”{% endif %}
    </div>

    <div>
      <a href="{% url 'user_create' %}" class="btn btn-sm btn-primary">Create user</a>
    </div>
  </div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:48px;"></th>
          <th>Login</th>
          <th>Full name</th>
          <th>Email</th>
          <th class="text-center">Admin</th>
          <th class="text-center">Local</th>
          <th class="text-end" style="width:260px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if users %}
          {% for u in users %}
            <tr>
              <td>
                {% if u.avatar_url %}
                  <img src="{{ u.avatar_url }}" alt="" class="rounded-circle" style="width:36px; height:36px; object-fit:cover;">
                {% else %}
                  <div class="rounded-circle bg-light border" style="width:36px; height:36px;"></div>
                {% endif %}
              </td>

              <td>
                <div class="fw-semibold">{{ u.login }}</div>
                {% if u.id %}
                  <div class="small text-muted">Gitea ID: {{ u.id }}</div>
                {% endif %}
              </td>

              <td>
                {% if u.full_name %}
                  {{ u.full_name }}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>

              <td>
                {% if u.email %}
                  <a href="mailto:{{ u.email }}" class="text-decoration-none">{{ u.email }}</a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>

              <td class="text-center">
                {% if u.is_admin %}
                  <span class="badge text-bg-warning">admin</span>
                {% else %}
                  <span class="badge text-bg-secondary">no</span>
                {% endif %}
              </td>

              <td class="text-center">
                {% if u.local_pk %}
                  <span class="badge text-bg-success">linked</span>
                {% else %}
                  <span class="badge text-bg-light border">remote only</span>
                {% endif %}
              </td>

              <td class="text-end">
                {% if u.local_pk %}
                  <a href="{% url 'user_edit' user_id=u.local_pk %}" class="btn btn-sm btn-outline-primary">Edit</a>

                  <form method="post" action="{% url 'user_resend_invite' user_id=u.local_pk %}" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary">Resend</button>
                  </form>

                  <form method="post" action="{% url 'user_delete' user_id=u.local_pk %}" class="d-inline"
                        onsubmit="return confirm('Delete this user locally? A delete will also be attempted on Gitea.');">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                {% else %}
                  <button class="btn btn-sm btn-outline-primary" disabled title="No local user matched">Edit</button>
                  <button class="btn btn-sm btn-outline-secondary" disabled title="No local user matched">Resend</button>
                  <button class="btn btn-sm btn-outline-danger" disabled title="No local user matched">Delete</button>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              No users found.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="d-flex align-items-center justify-content-between mt-3">
    <div class="text-muted small">Page {{ page }}</div>
    <div class="btn-group">
      <a class="btn btn-sm btn-outline-secondary {% if not has_prev %}disabled{% endif %}"
         href="{% if has_prev %}?page={{ prev_page }}&limit={{ limit }}{% if query %}&query={{ query|urlencode }}{% endif %}{% else %}#{% endif %}">
        ‹ Prev
      </a>
      <a class="btn btn-sm btn-outline-secondary {% if not has_next %}disabled{% endif %}"
         href="{% if has_next %}?page={{ next_page }}&limit={{ limit }}{% if query %}&query={{ query|urlencode }}{% endif %}{% else %}#{% endif %}">
        Next ›
      </a>
    </div>
  </div>

</div>

{% endblock %}

{# templates/gitea/users.html (por exemplo) #}
{% extends "base_sidebar.html" %}
{% load static %}

{% block title %}Console — Gitea Users{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    .badge-pill{
      border-radius:999px;
    }
    .table thead th{
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:var(--text-dim);
    }
  </style>
{% endblock %}

{% block content %}
  <div class="py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="h4 mb-1">Gitea users</h1>
        <p class="text-muted mb-0">
          Read-only list fetched from Gitea. Local users are matched by username/email.
        </p>
      </div>

      <div>
        {# usa o nome namespaced 'accounts:user_create' #}
        <a href="{% url 'accounts:user_create' %}" class="btn btn-sm btn-primary">
          Create user
        </a>
      </div>
    </div>

    {# Alert de erro geral da API, se houver #}
    {% if error %}
      <div class="alert alert-danger">
        Failed to load users from Gitea: {{ error }}
      </div>
    {% endif %}

    <div class="og-card mb-3 p-3">
      <form method="get" class="row gy-2 gx-2 align-items-end">
        <div class="col-md-4">
          <label for="query" class="form-label small text-muted mb-1">Search</label>
          <input
            type="text"
            id="query"
            name="query"
            value="{{ query }}"
            class="form-control form-control-sm"
            placeholder="Filter by username or email"
          >
        </div>

        <div class="col-md-3 col-6">
          <label for="limit" class="form-label small text-muted mb-1">Per page</label>
          <select id="limit" name="limit" class="form-select form-select-sm">
            {% for opt in limit_options %}
              <option value="{{ opt }}" {% if opt == limit %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3 col-6">
          <label class="form-label small text-muted mb-1 d-block">&nbsp;</label>
          <button type="submit" class="btn btn-sm btn-outline-secondary w-100">
            Apply
          </button>
        </div>

        <div class="col-md-2 text-md-end">
          <label class="form-label small text-muted mb-1 d-block">Page</label>
          <div class="small text-muted">
            <strong>{{ page }}</strong>
            {% if total %}
              · total <strong>{{ total }}</strong> result{{ total|pluralize }}
            {% endif %}
            {% if query %}<br>Filter: “<em>{{ query }}</em>”{% endif %}
          </div>
        </div>
      </form>
    </div>

    <div class="og-card p-0">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th scope="col">Username</th>
              <th scope="col">Email</th>
              <th scope="col">Local</th>
              <th scope="col" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if users %}
              {% for u in users %}
                <tr>
                  <td>
                    <span class="fw-semibold">{{ u.login }}</span>
                    {% if u.full_name %}
                      <div class="small text-muted">{{ u.full_name }}</div>
                    {% endif %}
                  </td>
                  <td>
                    {% if u.email %}
                      {{ u.email }}
                    {% else %}
                      <span class="text-muted small">—</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if u.local_pk %}
                      <span class="badge bg-success-subtle text-success-emphasis badge-pill">
                        Linked
                      </span>
                    {% else %}
                      <span class="badge bg-secondary-subtle text-secondary-emphasis badge-pill">
                        No local user
                      </span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if u.local_pk %}
                      <div class="btn-group btn-group-sm" role="group">
                        <a
                          href="{% url 'accounts:user_edit' u.local_pk %}"
                          class="btn btn-outline-secondary btn-sm"
                        >
                          Edit
                        </a>

                        <form
                          action="{% url 'accounts:user_resend_invite' u.local_pk %}"
                          method="post"
                          class="d-inline"
                        >
                          {% csrf_token %}
                          <button type="submit" class="btn btn-outline-secondary btn-sm">
                            Resend invite
                          </button>
                        </form>

                        <form
                          action="{% url 'accounts:user_delete' u.local_pk %}"
                          method="post"
                          class="d-inline"
                          onsubmit="return confirm('Delete this user?');"
                        >
                          {% csrf_token %}
                          <button type="submit" class="btn btn-outline-danger btn-sm">
                            Delete
                          </button>
                        </form>
                      </div>
                    {% else %}
                      <span class="text-muted small">No local actions</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="4" class="text-center py-4 text-muted">
                  No users found for this page/filter.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center p-3 border-top small text-muted">
        <div>
          Showing page <strong>{{ page }}</strong>
          {% if total %}
            · {{ users|length }} of {{ total }} users on this page
          {% endif %}
        </div>

        <div class="d-flex gap-2">
          {% if has_prev %}
            <a
              class="btn btn-sm btn-outline-secondary"
              href="?page={{ prev_page }}&limit={{ limit }}{% if query %}&query={{ query|urlencode }}{% endif %}"
            >
              ‹ Prev
            </a>
          {% else %}
            <button class="btn btn-sm btn-outline-secondary" disabled>‹ Prev</button>
          {% endif %}

          {% if has_next %}
            <a
              class="btn btn-sm btn-outline-secondary"
              href="?page={{ next_page }}&limit={{ limit }}{% if query %}&query={{ query|urlencode }}{% endif %}"
            >
              Next ›
            </a>
          {% else %}
            <button class="btn btn-sm btn-outline-secondary" disabled>Next ›</button>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
{% endblock %}

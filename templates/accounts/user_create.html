{% extends "base_sidebar.html" %}
{% load static %}
{% block title %}Create User{% endblock %}

{% block content %}
<div class="mx-auto" style="max-width: 800px;">
  <div class="og-card p-4" role="region" aria-labelledby="create-user-title">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 id="create-user-title" class="h5 m-0">Create User</h1>
      <a href="{% url 'gitea_users' %}" class="btn btn-outline-secondary btn-sm">Back to list</a>
    </div>

    {# Non-field / global form errors #}
    {% if form.non_field_errors %}
      <div class="alert alert-warning py-2 mb-3" role="alert" aria-live="polite">
        {% for err in form.non_field_errors %}
          {{ err|escape }}{% if not forloop.last %}<br/>{% endif %}
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" novalidate autocomplete="off" aria-describedby="create-user-help">
      {% csrf_token %}

      <div class="row g-3">

        {# FIRST NAME #}
        <div class="col-md-6">
          <div class="form-floating">
            <input
              type="text"
              inputmode="text"
              class="form-control{% if form.first_name.errors %} is-invalid{% endif %}"
              id="{{ form.first_name.id_for_label }}"
              name="{{ form.first_name.html_name }}"
              value="{{ form.first_name.value|default_if_none:''|escape }}"
              placeholder="First name"
              autocomplete="given-name"
            >
            <label for="{{ form.first_name.id_for_label }}">First name</label>
            {% if form.first_name.errors %}
              <div class="invalid-feedback d-block">
                {% for e in form.first_name.errors %}{{ e|escape }}{% if not forloop.last %}<br/>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>

        {# LAST NAME #}
        <div class="col-md-6">
          <div class="form-floating">
            <input
              type="text"
              inputmode="text"
              class="form-control{% if form.last_name.errors %} is-invalid{% endif %}"
              id="{{ form.last_name.id_for_label }}"
              name="{{ form.last_name.html_name }}"
              value="{{ form.last_name.value|default_if_none:''|escape }}"
              placeholder="Last name"
              autocomplete="family-name"
            >
            <label for="{{ form.last_name.id_for_label }}">Last name</label>
            {% if form.last_name.errors %}
              <div class="invalid-feedback d-block">
                {% for e in form.last_name.errors %}{{ e|escape }}{% if not forloop.last %}<br/>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>

        {# EMAIL #}
        <div class="col-12">
          <div class="form-floating">
            <input
              type="email"
              class="form-control{% if form.email.errors %} is-invalid{% endif %}"
              id="{{ form.email.id_for_label }}"
              name="{{ form.email.html_name }}"
              value="{{ form.email.value|default_if_none:''|escape }}"
              placeholder="user@example.com"
              required
              autocomplete="email"
              inputmode="email"
            >
            <label for="{{ form.email.id_for_label }}">Email</label>
            {% if form.email.errors %}
              <div class="invalid-feedback d-block">
                {% for e in form.email.errors %}{{ e|escape }}{% if not forloop.last %}<br/>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>

        {# ROLE #}
        <div class="col-12">
          <div class="form-floating">
            {% with current=form.role.value|stringformat:'s' %}
              <select
                class="form-select{% if form.role.errors %} is-invalid{% endif %}"
                id="{{ form.role.id_for_label }}"
                name="{{ form.role.html_name }}"
                aria-label="Role"
              >
                {% for val,label in form.role.field.choices %}
                  {% with v=val|stringformat:'s' %}
                    {# Se o usuário atual for manager, desabilita a opção "admin" no cliente (UX only) #}
                    {% if val == 'admin' and request.user.is_manager %}
                      <option value="{{ val }}" disabled>{{ label }} (not allowed)</option>
                    {% else %}
                      <option value="{{ val }}" {% if current == v %}selected{% endif %}>{{ label }}</option>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </select>
            {% endwith %}
            <label for="{{ form.role.id_for_label }}">Role</label>
            {% if form.role.errors %}
              <div class="invalid-feedback d-block">
                {% for e in form.role.errors %}{{ e|escape }}{% if not forloop.last %}<br/>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
          <div class="form-text mt-1" id="create-user-help">
            Managers <strong>cannot</strong> create Admin users (enforced server-side).
          </div>
        </div>

        {# GITEA FULL NAME #}
        <div class="col-12">
          <div class="form-floating">
            <input
              type="text"
              class="form-control{% if form.gitea_full_name.errors %} is-invalid{% endif %}"
              id="{{ form.gitea_full_name.id_for_label }}"
              name="{{ form.gitea_full_name.html_name }}"
              value="{{ form.gitea_full_name.value|default_if_none:''|escape }}"
              placeholder="Full name (Gitea)"
              autocomplete="name"
            >
            <label for="{{ form.gitea_full_name.id_for_label }}">Full name (Gitea)</label>
            {% if form.gitea_full_name.errors %}
              <div class="invalid-feedback d-block">
                {% for e in form.gitea_full_name.errors %}{{ e|escape }}{% if not forloop.last %}<br/>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>

        {# GITEA VISIBILITY #}
        <div class="col-12">
          <div class="form-floating">
            {% with current=form.gitea_visibility.value|stringformat:'s' %}
              <select
                class="form-select{% if form.gitea_visibility.errors %} is-invalid{% endif %}"
                id="{{ form.gitea_visibility.id_for_label }}"
                name="{{ form.gitea_visibility.html_name }}"
                aria-label="Gitea visibility"
              >
                {% if form.gitea_visibility.field.blank or not form.gitea_visibility.field.required %}
                  <option value="" {% if not current %}selected{% endif %}></option>
                {% endif %}
                {% for val,label in form.gitea_visibility.field.choices %}
                  {% with v=val|stringformat:'s' %}
                    <option value="{{ val }}" {% if current == v %}selected{% endif %}>{{ label }}</option>
                  {% endwith %}
                {% endfor %}
              </select>
            {% endwith %}
            <label for="{{ form.gitea_visibility.id_for_label }}">Gitea visibility</label>
            {% if form.gitea_visibility.errors %}
              <div class="invalid-feedback d-block">
                {% for e in form.gitea_visibility.errors %}{{ e|escape }}{% if not forloop.last %}<br/>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
          <div class="form-text mt-1">
            Controls how the user profile is shown inside Gitea.
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-end mt-4 gap-2">
        <a href="{% url 'gitea_users' %}" class="btn btn-outline-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">Create user</button>
      </div>
    </form>

    <hr class="my-4"/>

    <div class="small text-muted">
      After creation, the user will receive a one-time link to set the password.
      If SMTP is not configured, you’ll get a copyable link on the next screen.
    </div>

  </div>
</div>

{% block extra_js %}
<script>
  // Lowercase email on blur to help uniqueness and consistency
  (function(){
    const emailInput = document.getElementById("{{ form.email.id_for_label }}");
    if (!emailInput) return;
    emailInput.addEventListener('blur', function () {
      try {
        this.value = this.value.trim().toLowerCase();
      } catch (e) { /* noop */ }
    });
  })();
</script>
{% endblock %}
{% endblock %}
